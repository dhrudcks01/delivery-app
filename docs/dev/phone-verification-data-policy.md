# 휴대폰 본인인증 데이터 저장 정책 (T-0117)

## 1) 저장 대상
- 사용자 프로필(`users`)
  - `phone_e164`: 인증된 휴대폰 번호(E.164)
  - `phone_verified_at`: 최종 인증 완료 시각
  - `phone_verification_provider`: 인증 제공자 코드 (예: `PORTONE_DANAL`)
  - `identity_verification_id`: 포트원 본인인증 거래 식별자
  - `ci`, `di`: 본인 식별 연계 정보(민감 식별값)
- 인증 이력(`user_phone_verifications`)
  - 요청/완료/실패/중복/취소 상태와 실패 코드/메시지, 시각 이력 저장

## 2) 상태 모델 정의
- `REQUESTED`: 본인인증 요청 생성
- `VERIFIED`: 인증 성공, 사용자 프로필 갱신 대상
- `FAILED`: 인증 실패(실패 코드/메시지 기록)
- `DUPLICATE`: 중복 인증 시도 감지
- `CANCELED`: 사용자 취소 또는 중단

재인증은 기존 행 수정이 아닌 신규 이력(`REQUESTED`) 행 추가로 관리한다.

## 3) 민감 정보(`ci`, `di`) 보호 정책
- 저장 전 애플리케이션 계층 암호화(AES-256-GCM 권장, 키는 환경변수/시크릿 매니저 관리)
- 로그 출력 금지(요청/응답/예외 로그 모두 비노출)
- 조회 API 기본 비노출, 운영/감사 목적 최소 권한에서만 접근 허용
- 화면 노출 금지(마스킹 대상이 아닌 비표시 대상)

## 4) 중복/멱등 처리 정책
- 동일 `identity_verification_id`는 DB Unique로 1회만 저장
- 완료 처리 API는 동일 거래 재처리 시 기존 결과를 반환하는 멱등 동작을 기본 정책으로 한다.

## 5) 기존 사용자 호환성
- 기존 사용자는 신규 컬럼이 `NULL` 상태로 유지되며 기본값은 "미인증"으로 해석한다.
- 이후 차단 정책(T-0119) 적용 전까지는 데이터 모델만 선적용한다.
